<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=<device-width>, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Movies</title>

    <script src="http://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
    </script>
</head>
<body>
    <script>
        // get data from API with promises
        var moviesPromise = new Promise(resolve => {
            $.get('http://159.203.175.239:9001/movies.txt', function(data){
                resolve(data);
            });
        });
        
        var checkoutsPromise = new Promise(resolve => {
            $.get('http://159.203.175.239:9001/checkouts.txt', function(data){
                resolve(data);
            });
        });
        
        checkoutsPromise.then(function(data){
            processCheckoutData(data);
        });
      
        moviesPromise.then(function(data){
            //console.log(data);
        });

        function processCheckoutData(rawCheckoutData){
            var splitCheckoutData = rawCheckoutData.split(/\s+/g);
            var checkoutsArray = [];
            var usersArray = [];
            
            //most checkouts
            var mostCheckouts = {};
            mostCheckouts.numberOfCheckouts = 0;

            //checkouts by month
            var months = {}

            for(var i = 0; i < splitCheckoutData.length; i += 3){
                // parse checkout from splitcheckoutdata and push onto an array of checkouts
                var checkout = parseCheckout(splitCheckoutData,i)
                checkoutsArray.push(checkout);
                parseUser(usersArray, checkout);
                addCheckoutToMonth(months, checkout.checkoutMonth);
            }
            console.log("Checkouts: ", checkoutsArray);
            console.log("Users: ", usersArray);
            console.log("Months: ", months);
            console.log("Month with most checkouts: ", findMonthWithMostCheckouts(months));
        }

        function findMonthWithMostCheckouts(months){
            var mostCheckouts = 0;
            var monthWithMostCheckouts = "";
            //loop through months, if number of checkouts is bigger than the current max, make it the current max
            for (var month in months) {
                if(months[month] > mostCheckouts){
                    monthWithMostCheckouts = month;
                    mostCheckouts = months[month];
                }
            }
            return monthWithMostCheckouts;
        }

        function addCheckoutToMonth(months,monthKey){
            //add checkouts to month
            if(months[monthKey] === undefined){
                months[monthKey] = 0;
            }
            months[monthKey]++;
        }

        function parseCheckout(splitCheckoutData, index){
            //This creates a checkout object from an array of lines containing checkout information
            //Be careful to pass the index starting at the correct place or all data will be stored in the wrong field of the object
            
            var checkout = {
                    userId: splitCheckoutData[index],
                    checkoutMonth: splitCheckoutData[index+1],
                    movieCheckedOut: Number.parseInt(splitCheckoutData[index+2]),
                };
            return checkout;
        }

        function parseUser(usersArray, checkout){
            //NOTE: using bracket [] notation to index properties of objects to quickly look them up
            //if user doesn't exist, create new user and push onto array
            var userKey = checkout.userId.toString();

            if(usersArray[userKey] === undefined){                    
                usersArray[userKey] = {
                    userId: checkout.userId,
                    numberOfCheckouts: 1,
                    moviesCheckedOut: [checkout.movieCheckedOut]
                }
            }
            //if user does exist, update user information
            else{
                usersArray[userKey].numberOfCheckouts++;
                //add the movie to the array of movies the user checked out if it isn't already there
                if(usersArray[userKey].moviesCheckedOut[checkout.movieCheckedOut] === undefined){
                    usersArray[userKey].moviesCheckedOut.push(checkout.movieCheckedOut);
                }
            }
        }

        // let myFirstPromise = new Promise((resolve, reject) => {
        //     // We call resolve(...) when what we were doing async succeeded, and reject(...) when it failed.
        //     // In this example, we use setTimeout(...) to simulate async code. 
        //     // In reality, you will probably be using something like XHR or an HTML5 API.
        //     setTimeout(function(){
        //         resolve("Success!"); // Yay! Everything went well!
        //     }, 250);
        // });

        // myFirstPromise.then((successMessage) => {
        //     // successMessage is whatever we passed in the resolve(...) function above.
        //     // It doesn't have to be a string, but if it is only a succeed message, it probably will be.
        //     console.log("Yay! " + successMessage);
        // });


    </script>
</body>
</html>